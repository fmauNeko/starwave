name: Push and PR

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    outputs:
      docker_matrix: ${{ steps.matrix.outputs.docker_matrix }}
      helm_matrix: ${{ steps.matrix.outputs.helm_matrix }}
      releases_created: ${{ steps.release.outputs.releases_created }}
      prs_created: ${{ steps.release.outputs.prs_created }}
      pr: ${{ steps.release.outputs.pr }}
    steps:
      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4
        id: release
      - name: Generate matrix output
        id: matrix
        run: |
          outputs='${{ toJson(steps.release.outputs) }}'
          echo "::group::Input"
          echo "$outputs"
          echo "::endgroup::"
          targets=$(jq -n --argjson r "$outputs" '
            (($r.paths_released // "[]") | fromjson? // []) |
            map(. as $p | {path:$p, name:($p|split("/")|last), tag_name:($r[$p+"--tag_name"] // "")})
          ')
          echo docker_matrix=$(echo "$targets" | jq -c '{target:[.[]|select(.path|startswith("apps/"))]}') >> $GITHUB_OUTPUT
          echo helm_matrix=$(echo "$targets" | jq -c '{target:[.[]|select(.path|startswith("charts/"))]}') >> $GITHUB_OUTPUT

  docker-release:
    name: Docker release build
    if: ${{ fromJson(needs.release.outputs.docker_matrix).target[0] != null }}
    runs-on: ubuntu-latest
    needs: [release]
    strategy:
      matrix: ${{ fromJson(needs.release.outputs.docker_matrix) }}
    steps:
      - uses: benc-uk/workflow-dispatch@e2e5e9a103e331dad343f381a29e654aea3cf8fc # v1
        with:
          workflow: docker-release.yaml
          inputs: |
            {
              "target": "${{ matrix.target.name }}"
            }
          ref: ${{ matrix.target.tag_name }}

  helm-release:
    name: Helm chart release
    if: ${{ fromJson(needs.release.outputs.helm_matrix).target[0] != null }}
    runs-on: ubuntu-latest
    needs: [release]
    strategy:
      matrix: ${{ fromJson(needs.release.outputs.helm_matrix) }}
    steps:
      - name: Dispatch Helm chart release
        uses: benc-uk/workflow-dispatch@e2e5e9a103e331dad343f381a29e654aea3cf8fc # v1
        with:
          workflow: helm-release.yaml
          ref: ${{ matrix.target.tag_name }}

  update-chart-appversion:
    name: Update Helm chart appVersion
    if: ${{ needs.release.outputs.prs_created == 'true' }}
    runs-on: ubuntu-latest
    needs: [release]
    outputs:
      updated: ${{ steps.update.outputs.updated }}
    steps:
      - name: Extract pending bot version from PR
        id: extract
        env:
          PR_JSON: ${{ needs.release.outputs.pr }}
        run: |
          # Parse PR body to find bot version: <summary>bot: X.Y.Z</summary>
          BOT_VERSION=$(echo "$PR_JSON" | jq -r '.body' | grep -oP '<summary>bot: \K[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          if [ -n "$BOT_VERSION" ]; then
            echo "bot_version=$BOT_VERSION" >> $GITHUB_OUTPUT
            echo "has_bot_release=true" >> $GITHUB_OUTPUT
            echo "Found pending bot release: $BOT_VERSION"
          else
            echo "has_bot_release=false" >> $GITHUB_OUTPUT
            echo "No pending bot release found in PR"
          fi

      - name: Generate GitHub App token
        if: steps.extract.outputs.has_bot_release == 'true'
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        if: steps.extract.outputs.has_bot_release == 'true'
        with:
          ref: main
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Check and update Chart.yaml appVersion
        if: steps.extract.outputs.has_bot_release == 'true'
        id: update
        run: |
          BOT_VERSION="${{ steps.extract.outputs.bot_version }}"
          CURRENT_APP_VERSION=$(grep -oP '^appVersion: \K.*' charts/starwave/Chart.yaml)

          echo "Pending bot version: $BOT_VERSION"
          echo "Current appVersion: $CURRENT_APP_VERSION"

          if [ "$CURRENT_APP_VERSION" = "$BOT_VERSION" ]; then
            echo "appVersion already matches pending bot version, skipping update"
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "Updating appVersion from $CURRENT_APP_VERSION to $BOT_VERSION"
            sed -i "s/^appVersion:.*/appVersion: ${BOT_VERSION}/" charts/starwave/Chart.yaml
            echo "updated=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.update.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add charts/starwave/Chart.yaml
          git commit -m "fix(chart): sync appVersion to ${{ steps.extract.outputs.bot_version }}"
          git push

  backmerge:
    name: Backmerge main into develop
    if: ${{ always() && needs.release.outputs.releases_created == 'true' }}
    runs-on: ubuntu-latest
    needs: [release, update-chart-appversion]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: main
          fetch-depth: 0

      - name: Backmerge main into develop
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout develop
          git merge --no-ff main -m "chore: backmerge main into develop [skip ci]"
          git push
