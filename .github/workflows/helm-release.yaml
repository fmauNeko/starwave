name: Helm chart release

on:
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read
  attestations: write
  packages: write

jobs:
  release:
    name: Helm release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Log in to the Container registry
        run: |
          helm registry login \
            --username ${{ github.actor }} \
            --password ${{ secrets.GITHUB_TOKEN }} \
            ghcr.io

      - name: Install chart-releaser
        env:
          CHART_RELEASER_VERSION: v1.7.0
        run: |
          set -euo pipefail
          : "${RUNNER_TOOL_CACHE:?RUNNER_TOOL_CACHE is required}"
          arch="$(uname -m)"
          install_dir="${RUNNER_TOOL_CACHE}/cr/${CHART_RELEASER_VERSION}/${arch}"

          if [ ! -d "${install_dir}" ]; then
            mkdir -p "${install_dir}"
            pkg_arch="linux_amd64"
            if [ "${arch}" = "arm64" ] || [ "${arch}" = "aarch64" ]; then
              pkg_arch="linux_arm64"
            fi

            curl -sSLo cr.tar.gz "https://github.com/helm/chart-releaser/releases/download/${CHART_RELEASER_VERSION}/chart-releaser_${CHART_RELEASER_VERSION#v}_${pkg_arch}.tar.gz"
            tar -xzf cr.tar.gz -C "${install_dir}"
            rm -f cr.tar.gz
          fi

          echo "${install_dir}" >> "${GITHUB_PATH}"

      - name: Package charts for GHCR
        env:
          CHARTS_DIR: charts
        run: |
          set -euo pipefail

          rm -rf .cr-release-packages
          mkdir -p .cr-release-packages

          find "${CHARTS_DIR}" -maxdepth 1 -mindepth 1 -type d | while read -r chart; do
            if [ -f "${chart}/Chart.yaml" ]; then
              echo "::group::Packaging ${chart}"
              cr package "${chart}" --package-path .cr-release-packages
              echo "::endgroup::"
            else
              echo "Skipping ${chart}; Chart.yaml missing"
            fi
          done

          if ! compgen -G ".cr-release-packages/*.tgz" > /dev/null; then
            echo "No chart packages built."
          fi

      - name: Push charts to GHCR
        run: |
          shopt -s nullglob
          for pkg in .cr-release-packages/*; do
            if [ -z "${pkg:-}" ]; then
              break
            fi
            helm push "${pkg}" $(echo "oci://ghcr.io/${GITHUB_REPOSITORY}/charts" | tr '[:upper:]' '[:lower:]')
          done
